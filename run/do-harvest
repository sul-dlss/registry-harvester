#!/bin/bash

. /s/SUL/Config/sirsi.env

HOME=/s/SUL/Harvester
LOG=$HOME/log
OUT=$HOME/out
DATE=$1

if [ -z $DATE ]
then
  DATE=`date +%Y%m%d%H%M`
fi

$HOME/run/runonce.sh
$HOME/run/usertrans $DATE

perl -p -i -e 's/\r//g' $LOG/harvest.log

# yesterday...
illiad_date=`/s/sirsi/Unicorn/Bin/transdate -d-1`
echo "Updating/Inserting keys from /s/SUL/Batchlog/userload.keys.$illiad_date into ILLiad" >> $LOG/harvest.log
$HOME/run/pop2illiad $illiad_date

cat $LOG/harvest.log | mailx -s 'Harvest Log' sul-unicorn-devs@lists.stanford.edu

mv $LOG/harvest.log $LOG/harvest.log.$DATE
mv $OUT/harvest.out $OUT/harvest.out.$DATE
mv $LOG/illiad.log $LOG/illiad.log.$illiad_date.$DATE

touch $LOG/harvest.log
touch $LOG/illiad.log
