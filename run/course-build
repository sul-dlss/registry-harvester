#!/bin/bash

. /s/SUL/Config/sirsi.env

HOME=/s/SUL/Harvester
DATA=/s/SUL/Dataload/CourseReserves
LOG=$HOME/log
OUT=$HOME/out
JVM1=$1
JVM2=$2
OUTFile=$3
DATE=`date +%Y%m%d%H%M`
YEAR=`date +%y`
NEXTYR=`date +%y -d "+1 year"`
CENT=`date +%C`

/usr/local/rvm/wrappers/ruby-2.2.4/ruby $HOME/run/remove_old_course_harvests.rb >> $LOG/course_build.log

if [ -z $JVM1 ]
then
  JVM1="2G"
fi

if [ -z $JVM2 ]
then
  JVM2="10G"
fi

if [ "$OUTFile" == "latest" ]
then
  for F in `ls $OUT/course_harvest.out.* | tail -1`
  do
    OUTFile="$F"
  done
elif [ -z $OUTFile ]
then
  for F in `ls $OUT/course_harvest.out.*`
  do
    OUTFile="$OUTFile $F"
  done
fi

cp $HOME/include/courses/*.xml $HOME/include/courses/LastRun/
cp $DATA/*.xml $DATA/LastRun/

cd $HOME/classes

echo "Running: java -Xms${JVM1} -Xmx${JVM2} -cp .:../lib/jdom-2.0.6.jar:shared/PropGet.class course/BuildCourseXML $OUTFile"

java -Xms${JVM1} -Xmx${JVM2} -cp .:../lib/jdom-2.0.6.jar:shared/PropGet.class course/BuildCourseXML $OUTFile

for T in 'W' 'Sp' 'Su' 'F'
do
  if [ -e $HOME/include/courses/courseXML_${T}${YEAR}.xml ]; then
    if grep -q "term=\"\\w\+\\s\{1\}${CENT}${NEXTYR}" $HOME/include/courses/courseXML_${T}${YEAR}.xml; then
      echo "There are ${CENT}${NEXTYR} courses in courseXML_${T}${YEAR}.xml" >> $LOG/course_build.log
      echo "copied courseXML_${T}${YEAR}.xml to courseXML_${T}${NEXTYR}.xml" >> $LOG/course_build.log
      cp $HOME/include/courses/courseXML_${T}${YEAR}.xml $HOME/include/courses/courseXML_${T}${NEXTYR}.xml
    fi
  fi
done

echo "Copied all courseXML files to /s/SUL/Dataload/CourseReserves" >> $LOG/course_build.log
cp $HOME/include/courses/courseXML_*.xml $DATA/

echo "" >> $LOG/course_build.log
echo "New files generated:" >> $LOG/course_build.log
ls -lS $HOME/include/courses/*.xml >> $LOG/course_build.log

echo "" >> $LOG/course_build.log
echo "Last Run:" >> $LOG/course_build.log
ls -lS $HOME/include/courses/LastRun/*.xml >> $LOG/course_build.log

cat $LOG/course_build.log | mailx -s 'Course Build Log' sul-unicorn-devs@lists.stanford.edu

mv $LOG/course_build.log $LOG/course_build.log.$DATE
touch $LOG/course_build.log
